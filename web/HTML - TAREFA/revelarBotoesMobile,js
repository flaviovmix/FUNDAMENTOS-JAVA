(function () {
  const tarefas = document.querySelectorAll('.cartao-tarefa');

  let inicioX = 0;
  let atualX = 0;
  let arrastando = false;
  let tarefaAtiva = null;

  const limiteAbertura = 60;   // quanto precisa arrastar para abrir
  const limiteSwipe = 8;       // px para considerar swipe e não clique

  // -------------------------------
  // SWIPE NO CELULAR (SEU CÓDIGO)
  // -------------------------------
  tarefas.forEach(tarefa => {
    const link = tarefa.querySelector('.cartao-tarefa-link');

    if (!link) return;

    link.addEventListener('touchstart', toqueInicio, { passive: true });
    link.addEventListener('touchmove', toqueMover, { passive: false });
    link.addEventListener('touchend', toqueFim);
  });

  function toqueInicio(e) {
    const toque = e.touches[0];

    inicioX = toque.clientX;
    atualX = inicioX;
    arrastando = true;

    tarefaAtiva = this.closest('.cartao-tarefa');

    // Fecha outras tarefas abertas
    document.querySelectorAll('.cartao-tarefa.mostrar-acoes').forEach(t => {
      if (t !== tarefaAtiva) t.classList.remove('mostrar-acoes');
    });
  }

  function toqueMover(e) {
    if (!arrastando || !tarefaAtiva) return;

    const toque = e.touches[0];
    atualX = toque.clientX;

    const deltaX = atualX - inicioX;

    // Só arrasta para a esquerda
    if (deltaX < 0) {
      e.preventDefault(); // bloquear scroll vertical

      const link = tarefaAtiva.querySelector('.cartao-tarefa-link');
      const limiteMaximo = -120;
      const deslocamento = Math.max(deltaX, limiteMaximo);

      link.style.transform = `translateX(${deslocamento}px)`;
    }
  }

  function toqueFim(e) {
    if (!arrastando || !tarefaAtiva) return;

    const deltaX = atualX - inicioX;
    const link = tarefaAtiva.querySelector('.cartao-tarefa-link');

    const foiSwipe = Math.abs(deltaX) > limiteSwipe;

    // Se foi swipe, evita o clique do link
    if (foiSwipe) {
      e.preventDefault();
    }

    // Se arrastou além do necessário → abre
    if (deltaX < -limiteAbertura) {
      tarefaAtiva.classList.add('mostrar-acoes');
      // deixa o CSS controlar no mobile
      link.style.transform = '';
    } else {
      // Volta ao normal
      tarefaAtiva.classList.remove('mostrar-acoes');
      link.style.transform = 'translateX(0)';
    }

    arrastando = false;
    tarefaAtiva = null;
  }

  // Fechar ações ao tocar fora (mobile)
  document.addEventListener(
    'touchstart',
    function (e) {
      const dentro = e.target.closest('.cartao-tarefa');
      if (!dentro) {
        document
          .querySelectorAll('.cartao-tarefa.mostrar-acoes')
          .forEach(t => t.classList.remove('mostrar-acoes'));
      }
    },
    { passive: true }
  );

  // -----------------------------------------
  // NOVO: BOTÃO .botao-acao-desktop NO DESKTOP
  // -----------------------------------------

  const botoesDesktop = document.querySelectorAll('.botao-acao-desktop');

  botoesDesktop.forEach(botao => {
    botao.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      const card = this.closest('.cartao-tarefa');
      if (!card) return;

      const link = card.querySelector('.cartao-tarefa-link');
      if (!link) return;

      const jaAberto = card.classList.contains('mostrar-acoes');

      // Fecha outros cartões abertos
      document.querySelectorAll('.cartao-tarefa.mostrar-acoes').forEach(t => {
        if (t !== card) {
          t.classList.remove('mostrar-acoes');
          const l = t.querySelector('.cartao-tarefa-link');
          if (l) l.style.transform = 'translateX(0)';
        }
      });

      if (jaAberto) {
        // fechar
        card.classList.remove('mostrar-acoes');
        link.style.transform = 'translateX(0)';
      } else {
        // abrir
        card.classList.add('mostrar-acoes');

        // no mobile quem manda é o CSS (.mostrar-acoes)
        // no desktop o CSS zera o transform, então forçamos inline:
        link.style.transform = 'translateX(-500px)';
      }
    });
  });

})();
